<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qu·∫£n l√Ω Nh√† Tr·ªç</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body { font-family: sans-serif; }
  .tab-content { display: none; }
  #rooms { display: block; }
  #print-container { display: none; }

  @media print {
    body > * { display: none !important; }
    #print-container { display: block !important; width: 100%; margin: 0; }
    .invoice-container { width: 300px; margin: 0 auto; padding: 10px; font-size: 12px; line-height: 1.4; border: none !important; }
  }
</style>
</head>
<body class="bg-gray-100 text-gray-800">

<div class="flex min-h-screen">

  <!-- Sidebar -->
  <aside class="w-60 bg-gray-800 text-white flex flex-col">
    <div class="p-4 text-xl font-bold text-center bg-green-600">üè† Qu·∫£n l√Ω Nh√† Tr·ªç</div>
    <nav class="flex-1 flex flex-col">
      <button class="tab px-4 py-3 text-left hover:bg-gray-700 transition" data-tab="rooms">Ph√≤ng</button>
      <button class="tab px-4 py-3 text-left hover:bg-gray-700 transition" data-tab="occupancy">Thu√™ / Tr·∫£</button>
      <button class="tab px-4 py-3 text-left hover:bg-gray-700 transition" data-tab="invoice">H√≥a ƒë∆°n</button>
      <button class="tab px-4 py-3 text-left hover:bg-gray-700 transition" data-tab="history">L·ªãch s·ª≠</button>
      <button class="tab px-4 py-3 text-left hover:bg-gray-700 transition" data-tab="settings">C√†i ƒë·∫∑t gi√°</button>
    </nav>
  </aside>

  <!-- Main content -->
  <main class="flex-1 p-4 overflow-auto">

    <!-- Rooms -->
    <section id="rooms" class="tab-content">
      <div class="bg-white rounded-xl shadow p-4 mb-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">‚ûï Th√™m ph√≤ng</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input id="roomName" placeholder="T√™n ph√≤ng (VD: P101)" class="p-2 border rounded col-span-2" />
          <input id="roomPrice" type="number" placeholder="Gi√° thu√™ (VNƒê)" class="p-2 border rounded" min="0" />
        </div>
        <div class="mt-4">
          <button id="addRoomBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">Th√™m ph√≤ng</button>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üìã Danh s√°ch ph√≤ng</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-gray-100">
                <th class="p-3">T√™n</th>
                <th class="p-3">Gi√°</th>
                <th class="p-3">Tr·∫°ng th√°i</th>
                <th class="p-3 text-center">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="roomTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Occupancy -->
    <section id="occupancy" class="tab-content">
      <div class="bg-white rounded-xl shadow p-4 mb-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üîë Thu√™ ph√≤ng</h2>
        <div class="grid sm:grid-cols-3 gap-3">
          <select id="occupRoom" class="p-2 border rounded col-span-2">
            <option value="">-- Ch·ªçn ph√≤ng tr·ªëng --</option>
          </select>
          <input id="tenantName" placeholder="T√™n ng∆∞·ªùi thu√™" class="p-2 border rounded" />
        </div>
        <div class="mt-4">
          <button id="rentBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">Thu√™ ph√≤ng</button>
        </div>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üö™ Tr·∫£ ph√≤ng</h2>
        <div class="grid sm:grid-cols-2 gap-3">
          <select id="freeRoom" class="p-2 border rounded">
            <option value="">-- Ch·ªçn (Ph√≤ng - Ng∆∞·ªùi thu√™) --</option>
          </select>
          <div class="flex items-center gap-2">
            <button id="freeBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">Tr·∫£ ph√≤ng</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Invoice -->
    <section id="invoice" class="tab-content">
      <div class="bg-white rounded-xl shadow p-4 mb-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üßæ T·∫°o h√≥a ƒë∆°n th√°ng</h2>
        <div class="grid sm:grid-cols-2 gap-3 mb-4">
          <input type="month" id="invoiceMonth" class="p-2 border rounded w-full">
          <button id="createInvoicesBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">T·∫°o h√≥a ƒë∆°n</button>
        </div>
        <div id="invoiceList" class="space-y-3 max-h-96 overflow-y-auto p-2 border rounded bg-gray-50"></div>
      </div>
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üìú Danh s√°ch h√≥a ƒë∆°n</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-gray-100">
                <th class="p-3">M√£</th>
                <th class="p-3">Ph√≤ng</th>
                <th class="p-3 text-right">T·ªïng (VNƒê)</th>
                <th class="p-3">Tr·∫°ng th√°i</th>
                <th class="p-3 text-center">In</th>
                <th class="p-3 text-center">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="invoiceTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- History -->
    <section id="history" class="tab-content">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">‚è±Ô∏è L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-gray-100">
                <th class="p-3">Th·ªùi gian</th>
                <th class="p-3">H√†nh ƒë·ªông</th>
                <th class="p-3">Chi ti·∫øt</th>
              </tr>
            </thead>
            <tbody id="historyTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section id="settings" class="tab-content">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">‚öôÔ∏è C√†i ƒë·∫∑t gi√° d·ªãch v·ª•</h2>
        <div class="grid sm:grid-cols-2 gap-3 mb-4">
          <div><label class="block mb-1 text-sm">ƒêi·ªán (ƒë/kWh)</label><input type="number" id="priceElec" class="p-2 border rounded w-full"></div>
          <div><label class="block mb-1 text-sm">N∆∞·ªõc (ƒë/m¬≥)</label><input type="number" id="priceWater" class="p-2 border rounded w-full"></div>
          <div><label class="block mb-1 text-sm">R√°c (ƒë/ph√≤ng/th√°ng)</label><input type="number" id="priceTrash" class="p-2 border rounded w-full"></div>
          <div><label class="block mb-1 text-sm">Wifi (ƒë/th√°ng)</label><input type="number" id="priceWifi" class="p-2 border rounded w-full"></div>
          <div><label class="block mb-1 text-sm">Ph√≠ kh√°c c·ªë ƒë·ªãnh</label><input type="number" id="priceOther" class="p-2 border rounded w-full"></div>
        </div>
        <button id="saveSettingsBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">L∆∞u gi√°</button>
      </div>
    </section>

  </main>
</div>

<div id="print-container"></div>

<script>
// ----- TABS -----
const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabContents.forEach(c => c.style.display = 'none');
    tabs.forEach(t => t.classList.remove('bg-green-700'));
    const target = document.getElementById(tab.dataset.tab);
    if(target) target.style.display='block';
    tab.classList.add('bg-green-700');
  });
});

// ----- UTILS -----
function escapeHtml(text){ return text? text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : ''; }
function fmtCurrency(n){ return Number(n).toLocaleString('vi-VN'); }

const API_BASE_URL = 'https://nhatro-mi7x.onrender.com/api';
async function fetchAPI(endpoint, method='GET', body=null){
  const options={method,headers:{'Content-Type':'application/json'}};
  if(body) options.body=JSON.stringify(body);
  const res=await fetch(`${API_BASE_URL}/${endpoint}`, options);
  if(!res.ok){ const err=await res.json().catch(()=>({error:`HTTP ${res.status}`})); throw new Error(err.error||`HTTP ${res.status}`);}
  return res.status===204?{}:res.json();
}

// ----- GLOBAL DATA -----
let globalRoomData=[], globalSettings={};

// ----- LOAD DATA -----
async function loadData(){
  await loadSettings();
  await loadRooms();
  await loadOccupancies();
  await loadInvoices();
  await loadHistory();
}

// ----- LOAD ROOMS -----
async function loadRooms(){
  try{
    const rooms=await fetchAPI('rooms'); globalRoomData=rooms;
    const tbody=document.getElementById('roomTable'); tbody.innerHTML='';
    let occupSel='<option value="">-- Ch·ªçn ph√≤ng tr·ªëng --</option>';
    rooms.forEach(r=>{
      tbody.innerHTML+=`<tr class="border-b hover:bg-gray-50 transition">
        <td class="p-3 font-medium">${escapeHtml(r.name)}</td>
        <td class="p-3">${fmtCurrency(r.price)} VNƒê</td>
        <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded ${r.status==='ƒêang thu√™'?'bg-red-100 text-red-800':'bg-green-100 text-green-800'}">${escapeHtml(r.status||'Tr·ªëng')}</span></td>
        <td class="p-3 text-center">
          <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition" onclick="deleteRoom('${r._id}')">X√≥a</button>
        </td>
      </tr>`;
      if(r.status==='Tr·ªëng') occupSel+=`<option value="${r._id}">${escapeHtml(r.name)}</option>`;
    });
    document.getElementById('occupRoom').innerHTML=occupSel;
    buildInvoiceList(rooms);
  }catch(e){ console.error(e); }
}

// ----- ADD / DELETE ROOM -----
document.getElementById('addRoomBtn').addEventListener('click', async ()=>{
  const name=document.getElementById('roomName').value.trim();
  const price=+document.getElementById('roomPrice').value;
  if(!name||isNaN(price)||price<=0) return alert('Nh·∫≠p t√™n v√† gi√° thu√™ h·ª£p l·ªá.');
  await fetchAPI('rooms','POST',{name,price});
  document.getElementById('roomName').value=''; document.getElementById('roomPrice').value='';
  await loadData();
});

async function deleteRoom(id){
  if(!confirm('X√°c nh·∫≠n x√≥a ph√≤ng?')) return;
  await fetchAPI(`rooms/${id}`,'DELETE'); await loadData();
}

// C√°c function kh√°c (thu√™, tr·∫£, t·∫°o h√≥a ƒë∆°n, in, thanh to√°n, settings...) 
// gi·ªØ nguy√™n logic c·ªßa b·∫°n, ch·ªâ thay ƒë·ªïi print sang #print-container.

</script>

</body>
</html>
