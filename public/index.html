<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qu·∫£n l√Ω Nh√† Tr·ªç</title>

<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#059669">

<script src="https://cdn.tailwindcss.com"></script>
<style>
  .tab-content { display: none; }
  #rooms { display: block; }

  @media print {
    body > * { display: none !important; }
    #print-container {
      display: block !important;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      z-index: 9999; 
    }
    /* Style cho h√≥a ƒë∆°n khi in */
    .invoice-container {
      width: 300px;
      margin: 0 auto;
      padding: 10px;
      font-size: 12px;
      line-height: 1.4;
      border: none !important; 
    }
    .invoice-container .header h1 { font-size: 14px; margin: 0; }
    .invoice-container table { font-size: 11px; }
  }
</style>
</head>
<body class="bg-gray-100 text-gray-800">

<header class="bg-green-600 text-white p-4 text-center text-xl font-bold shadow">
  üè† Qu·∫£n l√Ω Nh√† Tr·ªç
</header>

<div class="min-h-screen flex flex-col">

  <nav class="flex bg-gray-800 text-white shadow-lg">
    <button class="tab flex-1 px-4 py-3 bg-green-700 hover:bg-green-700 transition" data-tab="rooms">Ph√≤ng</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="occupancy">Thu√™ / Tr·∫£</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="invoice">H√≥a ƒë∆°n</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="history">L·ªãch s·ª≠</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="settings">C√†i ƒë·∫∑t gi√°</button>
  </nav>

  <main class="p-4 flex-1 space-y-4">

    <section id="rooms" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">‚ûï Th√™m ph√≤ng</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input id="roomName" placeholder="T√™n ph√≤ng (VD: P101)" class="p-2 border rounded col-span-2" />
          <input id="roomPrice" type="number" placeholder="Gi√° thu√™ (VNƒê)" class="p-2 border rounded" min="0" />
        </div>
        <button id="addRoomBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">Th√™m ph√≤ng</button>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üìã Danh s√°ch ph√≤ng</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left table-auto">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3">T√™n</th>
                <th class="p-3">Gi√°</th>
                <th class="p-3">Tr·∫°ng th√°i</th>
                <th class="p-3 text-center">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="roomTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="occupancy" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üîë Thu√™ ph√≤ng</h2>
        <div class="grid sm:grid-cols-3 gap-3">
          <select id="occupRoom" class="p-2 border rounded col-span-2">
            <option value="">-- Ch·ªçn ph√≤ng tr·ªëng --</option>
          </select>
          <input id="tenantName" placeholder="T√™n ng∆∞·ªùi thu√™" class="p-2 border rounded" />
        </div>
        <button id="rentBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">Thu√™ ph√≤ng</button>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üö™ Tr·∫£ ph√≤ng</h2>
        <div class="grid sm:grid-cols-2 gap-3">
          <select id="freeRoom" class="p-2 border rounded">
            <option value="">-- Ch·ªçn (Ph√≤ng - Ng∆∞·ªùi thu√™) --</option>
          </select>
          <button id="freeBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">Tr·∫£ ph√≤ng</button>
        </div>
      </div>
    </section>

    <section id="invoice" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üßæ T·∫°o h√≥a ƒë∆°n th√°ng</h2>
        
        <div class="grid sm:grid-cols-4 gap-3 mb-4">
          <input type="number" id="invoiceMonthInput" placeholder="Th√°ng (1-12)" min="1" max="12" class="p-2 border rounded w-full col-span-1">
          <input type="number" id="invoiceYearInput" placeholder="NƒÉm (YYYY)" min="2020" max="2050" class="p-2 border rounded w-full col-span-2">
          <button id="createInvoicesBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition col-span-1">T·∫°o h√≥a ƒë∆°n</button>
        </div>

        <h3 class="text-md font-medium mb-2">Nh·∫≠p ch·ªâ s·ªë/Ph√≠ ph√°t sinh</h3>
        <div id="invoiceList" class="space-y-3 max-h-96 overflow-y-auto p-2 border rounded bg-gray-50"></div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üìú Danh s√°ch h√≥a ƒë∆°n</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left table-auto">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3">M√£</th>
                <th class="p-3">Ph√≤ng</th>
                <th class="p-3 text-right">T·ªïng (VNƒê)</th>
                <th class="p-3">Tr·∫°ng th√°i</th>
                <th class="p-3 text-center">Xem/In</th>
                <th class="p-3 text-center">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="invoiceTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="history" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">‚è±Ô∏è L·ªãch s·ª≠ ho·∫°t ƒë·ªông</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left table-auto">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3">Th·ªùi gian</th>
                <th class="p-3">H√†nh ƒë·ªông</th>
                <th class="p-3">Chi ti·∫øt</th>
              </tr>
            </thead>
            <tbody id="historyTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="settings" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">‚öôÔ∏è C√†i ƒë·∫∑t gi√° d·ªãch v·ª•</h2>
        <div class="grid sm:grid-cols-2 gap-3 mb-4">
          <div>
            <label class="block mb-1 text-sm font-medium">Gi√° ƒëi·ªán (ƒë/kWh)</label>
            <input type="number" id="priceElec" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Gi√° n∆∞·ªõc (ƒë/m¬≥)</label>
            <input type="number" id="priceWater" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Ti·ªÅn r√°c (ƒë/ph√≤ng/th√°ng)</label>
            <input type="number" id="priceTrash" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Wifi (ƒë/th√°ng)</label>
            <input type="number" id="priceWifi" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Ph√≠ kh√°c c·ªë ƒë·ªãnh (ƒë/ph√≤ng/th√°ng)</label>
            <input type="number" id="priceOther" class="p-2 border rounded w-full" min="0">
          </div>
        </div>
        <button id="saveSettingsBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">L∆∞u gi√°</button>
      </div>
    </section>

  </main>
</div>

<div id="print-container" style="display: none;"></div>

<script>
// Vui l√≤ng ƒë·∫£m b·∫£o URL n√†y ƒëang ho·∫°t ƒë·ªông v√† kh√¥ng b·ªã l·ªói CORS/server down
const API_BASE_URL = 'https://nhatro-mi7x.onrender.com/api'; 


let globalRoomData = []; 
let globalSettings = {};

async function fetchAPI(endpoint, method = 'GET', body = null) {
  const options = {
    method,
    headers: { 'Content-Type': 'application/json' },
  };
  if (body) {
    options.body = JSON.stringify(body);
  }
  // Th√™m x·ª≠ l√Ω timeout ƒë·ªÉ d·ªÖ ph√°t hi·ªán server down
  const timeout = 10000; // 10 gi√¢y
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeout);

  try {
    const res = await fetch(`${API_BASE_URL}/${endpoint}`, { ...options, signal: controller.signal });
    clearTimeout(timeoutId);

    if (!res.ok) {
        let errorBody = {};
        try {
            errorBody = await res.json();
        } catch (e) {
            errorBody = { error: `L·ªói HTTP ${res.status}` };
        }
        throw new Error(errorBody.error || `HTTP error! status: ${res.status} (C√≥ th·ªÉ l√† l·ªói CORS)`);
    }
    return res.status === 204 ? {} : res.json();
  } catch (error) {
    clearTimeout(timeoutId);
    let errorMessage = `L·ªói k·∫øt n·ªëi ho·∫∑c x·ª≠ l√Ω: ${error.message}.`;
    if (error.name === 'AbortError') {
      errorMessage = 'L·ªói: Th·ªùi gian ch·ªù k·∫øt n·ªëi (Timeout) ƒë√£ h·∫øt. Server c√≥ th·ªÉ ƒëang ng·ªß (Render Free Tier) ho·∫∑c ƒë∆∞·ªùng truy·ªÅn y·∫øu.';
    }
    alert(errorMessage);
    console.error("Fetch API Error:", error);
    throw error; 
  }
}

const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabContents.forEach(c => c.style.display = 'none');
    tabs.forEach(t => t.classList.remove('bg-green-700'));

    const targetId = tab.dataset.tab;
    const targetContent = document.getElementById(targetId);
    if (targetContent) {
      targetContent.style.display = 'block';
    }

    tab.classList.add('bg-green-700');
  });
});

function escapeHtml(text) { if (!text) return ''; return text.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
function fmtCurrency(n) { return Number(n).toLocaleString('vi-VN'); }

async function loadRooms() {
  try {
    const rooms = await fetchAPI('rooms');
    globalRoomData = rooms; 
    
    const tbody = document.getElementById('roomTable');
    tbody.innerHTML = '';
    
    let occupSel = '<option value="">-- Ch·ªçn ph√≤ng tr·ªëng --</option>';
    rooms.forEach(r => {
      tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 transition">
        <td class="p-3 font-medium">${escapeHtml(r.name)}</td>
        <td class="p-3">${fmtCurrency(r.price)} VNƒê</td>
        <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded ${r.status === 'ƒêang thu√™' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${escapeHtml(r.status || 'Tr·ªëng')}</span></td>
        <td class="p-3 text-center">
          <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition" onclick="deleteRoom('${r._id}')">X√≥a</button>
        </td>
      </tr>`;
      if (r.status === 'Tr·ªëng') occupSel += `<option value="${r._id}">${escapeHtml(r.name)}</option>`;
    });
    document.getElementById('occupRoom').innerHTML = occupSel;
    buildInvoiceList(rooms);
  } catch (e) {
    console.error("L·ªói loadRooms:", e);
  }
}

document.getElementById('addRoomBtn').addEventListener('click', async () => {
  const name = document.getElementById('roomName').value.trim();
  const price = +document.getElementById('roomPrice').value;
  if (!name || isNaN(price) || price <= 0) return alert('Nh·∫≠p t√™n v√† gi√° thu√™ h·ª£p l·ªá.');
  
  await fetchAPI('rooms', 'POST', { name, price });
  
  document.getElementById('roomName').value = '';
  document.getElementById('roomPrice').value = '';
  await loadData();
});

async function deleteRoom(id) {
  if (!confirm('X√°c nh·∫≠n x√≥a ph√≤ng? H√†nh ƒë·ªông n√†y s·∫Ω x√≥a c√°c th√¥ng tin thu√™ li√™n quan.')) return;
  await fetchAPI(`rooms/${id}`, 'DELETE');
  await loadData();
}

async function loadOccupancies() {
  try {
    const data = await fetchAPI('occupancy');
    
    let freeHtml = '<option value="">-- Ch·ªçn m·ª•c ƒë·ªÉ tr·∫£ ph√≤ng --</option>';
    data.forEach(o => {
      if (o.active && o.room) {
        const roomName = o.room.name || 'Ph√≤ng';
        freeHtml += `<option value="${o._id}">${escapeHtml(roomName)} ‚Äî ${escapeHtml(o.tenant || '')}</option>`;
      }
    });
    document.getElementById('freeRoom').innerHTML = freeHtml;
  } catch (e) {
    console.error("L·ªói loadOccupancies:", e);
  }
}

document.getElementById('rentBtn').addEventListener('click', async () => {
  const roomId = document.getElementById('occupRoom').value;
  const tenant = document.getElementById('tenantName').value.trim();
  if (!roomId || !tenant) return alert('Ch·ªçn ph√≤ng v√† nh·∫≠p t√™n ng∆∞·ªùi thu√™.');
  
  await fetchAPI('occupancy', 'POST', { roomId, tenant });
  
  document.getElementById('tenantName').value = '';
  await loadData();
});

document.getElementById('freeBtn').addEventListener('click', async () => {
  const occId = document.getElementById('freeRoom').value;
  if (!occId) return alert('Ch·ªçn ph√≤ng c·∫ßn tr·∫£.');
  
  await fetchAPI(`occupancy/${occId}`, 'DELETE');
  
  await loadData();
});

async function loadHistory() {
  try {
    const data = await fetchAPI('history');
    
    const tbody = document.getElementById('historyTable');
    tbody.innerHTML = '';
    
    data.forEach(h => {
      tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 transition">
        <td class="p-3 text-sm">${new Date(h.createdAt).toLocaleString()}</td>
        <td class="p-3 font-medium">${escapeHtml(h.action)}</td>
        <td class="p-3 text-sm">${escapeHtml(h.info)}</td>
      </tr>`;
    });
  } catch (e) {
    console.error("L·ªói loadHistory:", e);
  }
}

async function loadSettings() {
  try {
    const s = await fetchAPI('settings');
    globalSettings = s;

    document.getElementById('priceElec').value = s.priceElec || 3000;
    document.getElementById('priceWater').value = s.priceWater || 10000;
    document.getElementById('priceTrash').value = s.priceTrash || 20000;
    document.getElementById('priceWifi').value = s.priceWifi || 50000;
    document.getElementById('priceOther').value = s.priceOther || 0; 

  } catch (e) {
    console.error("L·ªói loadSettings:", e);
  }
}

document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
  const s = {
    priceElec: +document.getElementById('priceElec').value,
    priceWater: +document.getElementById('priceWater').value,
    priceTrash: +document.getElementById('priceTrash').value,
    priceWifi: +document.getElementById('priceWifi').value,
    priceOther: +document.getElementById('priceOther').value
  };

  if(Object.values(s).some(val => isNaN(val) || val < 0)) return alert('Gi√° d·ªãch v·ª• ph·∫£i l√† s·ªë kh√¥ng √¢m.');

  await fetchAPI('settings', 'POST', s);
  
  alert('ƒê√£ l∆∞u gi√° d·ªãch v·ª• th√†nh c√¥ng!');
  await loadSettings(); 
});

function buildInvoiceList(rooms) {
  const container = document.getElementById('invoiceList');
  container.innerHTML = '';
  const roomsInUse = rooms.filter(r => r.status === 'ƒêang thu√™');
  
  if (roomsInUse.length === 0) {
    container.innerHTML = '<p class="text-center text-gray-500 py-4">Ch∆∞a c√≥ ph√≤ng n√†o ƒëang ƒë∆∞·ª£c thu√™.</p>';
    return;
  }
  
  roomsInUse.forEach(r => {
    container.innerHTML += `
      <div class="p-3 border rounded grid sm:grid-cols-6 gap-2 items-center bg-white shadow-sm" data-room-id="${r._id}" data-room-name="${r.name}">
        <div class="font-semibold text-green-700 col-span-full sm:col-span-1">${escapeHtml(r.name)}</div>
        <div><input type="number" placeholder="ƒêi·ªán Bƒê" class="p-1 border rounded w-full elecBegin" min="0"></div>
        <div><input type="number" placeholder="ƒêi·ªán KT" class="p-1 border rounded w-full elecEnd" min="0"></div>
        <div><input type="number" placeholder="N∆∞·ªõc Bƒê" class="p-1 border rounded w-full waterBegin" min="0"></div>
        <div><input type="number" placeholder="N∆∞·ªõc KT" class="p-1 border rounded w-full waterEnd" min="0"></div>
        <div class="col-span-full sm:col-span-1"><input type="number" placeholder="Ph√≠ kh√°c (N·∫øu c√≥)" class="p-1 border rounded w-full otherFee" value="0" min="0"></div>
      </div>`;
  });
}

async function createInvoices() {
  // S·ª≠a: L·∫•y th√°ng v√† nƒÉm t·ª´ input number
  const month = +document.getElementById('invoiceMonthInput').value;
  const year = +document.getElementById('invoiceYearInput').value;

  if (isNaN(month) || month < 1 || month > 12 || isNaN(year) || year < 2000) {
      return alert('Vui l√≤ng nh·∫≠p th√°ng v√† nƒÉm h·ª£p l·ªá.');
  }
  
  const s = globalSettings;
  if (!s || Object.keys(s).length === 0) {
    alert('Ch∆∞a t·∫£i ƒë∆∞·ª£c c√†i ƒë·∫∑t gi√° d·ªãch v·ª•. Vui l√≤ng ki·ªÉm tra tab C√†i ƒë·∫∑t.');
    return;
  }
  
  const items = [];
  let validInvoiceCount = 0;
  
  document.querySelectorAll('#invoiceList > div').forEach(div => {
    const roomId = div.dataset.roomId;
    const roomName = div.dataset.roomName;
    
    const elecBegin = +div.querySelector('.elecBegin').value;
    const elecEnd = +div.querySelector('.elecEnd').value;
    const waterBegin = +div.querySelector('.waterBegin').value;
    const waterEnd = +div.querySelector('.waterEnd').value;
    const otherFee = +div.querySelector('.otherFee').value || 0;

    if (isNaN(elecBegin) || isNaN(elecEnd) || isNaN(waterBegin) || isNaN(waterEnd) || 
        elecEnd < elecBegin || waterEnd < waterBegin || elecBegin < 0 || waterBegin < 0) {
      console.warn(`B·ªè qua h√≥a ƒë∆°n ph√≤ng ${roomName} do ch·ªâ s·ªë kh√¥ng h·ª£p l·ªá.`);
      return; 
    }
    
    items.push({
      roomId, 
      roomName, 
      month, 
      year, 
      elecBegin, 
      elecEnd, 
      waterBegin, 
      waterEnd,
      otherFee
    });
    validInvoiceCount++;
  });

  if (validInvoiceCount === 0) return alert('Kh√¥ng c√≥ h√≥a ƒë∆°n h·ª£p l·ªá n√†o ƒë∆∞·ª£c t·∫°o.');

  await fetchAPI('invoices', 'POST', { invoices: items });
  
  alert(`ƒê√£ t·∫°o ${validInvoiceCount} h√≥a ƒë∆°n th√†nh c√¥ng cho th√°ng ${month}/${year}!`);
  await loadData();
}

document.getElementById('createInvoicesBtn').addEventListener('click', createInvoices);

async function loadInvoices() {
  try {
    const invs = await fetchAPI('invoices');
    
    const tbody = document.getElementById('invoiceTable');
    tbody.innerHTML = '';
    
    invs.forEach(i => {
      const isPaid = i.paid;
      const roomName = i.roomName || (i.room?.name || 'Ph√≤ng'); 
      
      tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 transition">
        <td class="p-3 text-sm font-code">${escapeHtml(i.code)}</td>
        <td class="p-3">${escapeHtml(roomName)}</td>
        <td class="p-3 font-bold text-right text-red-600">${fmtCurrency(i.total)} VNƒê</td>
        <td class="p-3">
          <span class="px-2 py-1 text-xs font-semibold rounded ${isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
            ${isPaid ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n'}
          </span>
        </td>
        <td class="p-3 text-center">
          <button class="bg-indigo-500 text-white px-3 py-1 rounded text-sm hover:bg-indigo-600 transition" onclick="printInvoice('${i._id}')">In</button>
        </td>
        <td class="p-3 text-center">
          ${!isPaid ? `<button class="bg-blue-500 text-white px-3 py-1 rounded text-sm mb-1 hover:bg-blue-600 transition" onclick="payInvoice('${i._id}', true)">Thanh to√°n</button>` : `<button class="bg-yellow-500 text-white px-3 py-1 rounded text-sm mb-1 hover:bg-yellow-600 transition" onclick="payInvoice('${i._id}', false)">H·ªßy TT</button>`}
          <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition" onclick="deleteInvoice('${i._id}')">X√≥a</button>
        </td>
      </tr>`;
    });
  } catch (e) {
    console.error("L·ªói loadInvoices:", e);
  }
}

async function payInvoice(id, paidStatus) {
  const confirmMsg = paidStatus ? 'X√°c nh·∫≠n h√≥a ƒë∆°n n√†y ƒë√£ ƒë∆∞·ª£c thanh to√°n?' : 'X√°c nh·∫≠n H·ª¶Y tr·∫°ng th√°i ƒë√£ thanh to√°n?';
  if (!confirm(confirmMsg)) return;
  
  await fetchAPI(`invoices/${id}`, 'PUT', { paid: paidStatus });
  
  await loadData();
}

async function deleteInvoice(id) {
  if (!confirm('X√°c nh·∫≠n x√≥a h√≥a ƒë∆°n n√†y?')) return;
  await fetchAPI(`invoices/${id}`, 'DELETE');
  
  await loadData();
}

async function getInvoiceAndSettings(id) {
  const invs = await fetchAPI('invoices');
  const invoice = invs.find(i => i._id === id);
  const settings = await fetchAPI('settings'); 
  return { invoice, settings };
}

function generateInvoiceHtml(invoice, settings) {
  const isPaid = invoice.paid ? 'ƒê√É THANH TO√ÅN' : 'CH∆ØA THANH TO√ÅN';
  const monthYear = `${invoice.month}/${invoice.year}`;
  const total = fmtCurrency(invoice.total);
  const roomPrice = invoice.roomPrice || (invoice.room?.price || 0);
  
  const priceElec = invoice.elecTotal / (invoice.elecUsed || 1) || settings.priceElec || 3000;
  const priceWater = invoice.waterTotal / (invoice.waterUsed || 1) || settings.priceWater || 10000;

  return `
    <html>
    <head>
      <title>H√≥a ƒë∆°n ${invoice.code}</title>
      <style>
        body { font-family: Tahoma, sans-serif; font-size: 11px; margin: 0; padding: 0; }
        .invoice-container { width: 300px; margin: 0 auto; padding: 10px; border: 1px dashed #000; }
        .header { text-align: center; margin-bottom: 10px; }
        .header h1 { font-size: 14px; margin: 0; }
        .info-line { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .info-line .label { font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 8px; }
        th, td { padding: 4px 2px; text-align: left; border-bottom: 1px dotted #ddd; }
        .text-right { text-align: right; }
        .total-row { font-weight: bold; background-color: #eee; }
        .status { text-align: center; font-size: 14px; font-weight: bold; margin-top: 10px; padding: 5px; border: 2px solid ${invoice.paid ? 'green' : 'red'}; }
        .note { font-style: italic; font-size: 10px; margin-top: 10px; }
        
        @media print {
            .invoice-container { border: none !important; }
        }
      </style>
    </head>
    <body>
      <div class="invoice-container">
        <div class="header">
          <h1>PHI·∫æU THANH TO√ÅN TI·ªÄN TR·ªå</h1>
          <p style="margin: 3px 0;">---------------------</p>
          <p>K·ª≥: Th√°ng ${monthYear}</p>
        </div>
        
        <div style="margin-top: 5px;">
          <div class="info-line"><span class="label">Ph√≤ng:</span> <span>${invoice.roomName || ''}</span></div>
          <div class="info-line"><span class="label">M√£ Hƒê:</span> <span>${invoice.code}</span></div>
        </div>
        
        <hr style="margin: 8px 0; border-top: 1px dotted #000;"/>
        
        <table>
          <thead>
            <tr><th>D·ªãch v·ª•</th><th class="text-right">SL/ƒê∆°n gi√°</th><th class="text-right">Th√†nh ti·ªÅn (VNƒê)</th></tr>
          </thead>
          <tbody>
            <tr><td>1. Ti·ªÅn ph√≤ng</td><td class="text-right">Ph√≠ c·ªë ƒë·ªãnh</td><td class="text-right">${fmtCurrency(roomPrice)}</td></tr>
            <tr><td>2. Ti·ªÅn ƒëi·ªán</td><td class="text-right">${invoice.elecUsed} kWh x ${fmtCurrency(priceElec)}</td><td class="text-right">${fmtCurrency(invoice.elecTotal)}</td></tr>
            <tr><td>3. Ti·ªÅn n∆∞·ªõc</td><td class="text-right">${invoice.waterUsed} m¬≥ x ${fmtCurrency(priceWater)}</td><td class="text-right">${fmtCurrency(invoice.waterTotal)}</td></tr>
            <tr><td>4. Ph√≠ Wifi</td><td class="text-right">Ph√≠ c·ªë ƒë·ªãnh</td><td class="text-right">${fmtCurrency(invoice.wifi)}</td></tr>
            <tr><td>5. Ph√≠ R√°c</td><td class="text-right">Ph√≠ c·ªë ƒë·ªãnh</td><td class="text-right">${fmtCurrency(invoice.trash)}</td></tr>
            ${invoice.otherFee > 0 ? `<tr><td>6. Ph√≠ kh√°c</td><td class="text-right">Ph√°t sinh</td><td class="text-right">${fmtCurrency(invoice.otherFee)}</td></tr>` : ''}
          </tbody>
        </table>

        <hr style="margin: 8px 0; border-top: 1px solid #000;"/>

        <div class="info-line total-row" style="font-size: 12px; padding: 3px 0;">
          <span>T·ªîNG C·ªòNG:</span>
          <span class="text-right" style="font-size: 14px; color: #d9534f;">${total} VNƒê</span>
        </div>

        <div class="status" style="color: ${invoice.paid ? 'green' : 'red'};">${isPaid}</div>
        
        <p class="note">Xin qu√Ω kh√°ch ki·ªÉm tra k·ªπ h√≥a ƒë∆°n tr∆∞·ªõc khi thanh to√°n. C·∫£m ∆°n!</p>
        
        <div style="margin-top: 15px; display: flex; justify-content: space-around; text-align: center;">
            <div>Ng∆∞·ªùi l·∫≠p phi·∫øu</div>
            <div>Ng∆∞·ªùi thu√™</div>
        </div>
      </div>
    </body>
    </html>
  `;}

async function printInvoice(id) {
  try {
    const { invoice, settings } = await getInvoiceAndSettings(id);

    if (!invoice) return alert('Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n.');

    const printHtml = generateInvoiceHtml(invoice, settings);

    // FIX L·ªñI IN TR√äN IOS/SAFARI: D√πng iframe t·∫°m th·ªùi thay v√¨ window.open
    const printContainer = document.getElementById('print-container');
    printContainer.innerHTML = ''; 

    const iframe = document.createElement('iframe');
    iframe.style.width = '0';
    iframe.style.height = '0';
    iframe.style.position = 'absolute';
    iframe.style.border = '0';
    iframe.id = 'printIframe';
    
    printContainer.appendChild(iframe);

    const doc = iframe.contentWindow.document;
    doc.open();
    doc.write(printHtml);
    doc.close();

    iframe.onload = function() {
      iframe.contentWindow.focus();
      iframe.contentWindow.print();
      // T√πy ch·ªçn: X√≥a iframe sau khi in xong
      setTimeout(() => printContainer.innerHTML = '', 1000); 
    };

    printContainer.style.display = 'block';

  } catch (e) {
    console.error("L·ªói printInvoice:", e);
    alert('L·ªói khi chu·∫©n b·ªã in h√≥a ƒë∆°n.');
  }
}


async function loadData() {
  // B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu ƒë·ªìng th·ªùi ƒë·ªÉ ·ª©ng d·ª•ng t·∫£i nhanh h∆°n
  await Promise.all([
    loadSettings(), 
    loadRooms(), 
    loadOccupancies(),
    loadInvoices(),
    loadHistory()
  ]).catch(err => {
     console.error("L·ªói t·∫£i to√†n b·ªô d·ªØ li·ªáu:", err);
     // ƒê√£ c√≥ alert trong fetchAPI, kh√¥ng c·∫ßn alert l·∫°i ·ªü ƒë√¢y
  });
}

document.addEventListener('DOMContentLoaded', () => {
  const today = new Date();
  const month = (today.getMonth() + 1);
  const year = today.getFullYear();
  
  // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh cho √¥ Th√°ng/NƒÉm m·ªõi
  document.getElementById('invoiceMonthInput').value = month;
  document.getElementById('invoiceYearInput').value = year;
  
  loadData();

  // üöÄ PWA: ƒêƒÇNG K√ù SERVICE WORKER (T√™n file: sw.js)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js')
        .then((reg) => {
          console.log('Service Worker ƒë√£ ƒëƒÉng k√Ω th√†nh c√¥ng:', reg);
        })
        .catch((err) => {
          console.error('L·ªói ƒëƒÉng k√Ω Service Worker:', err);
        });
    });
  }
  // üîö END PWA
});
</script>

</body>
</html>
