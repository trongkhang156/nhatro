<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qu·∫£n l√Ω Nh√† Tr·ªç PWA</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#16a34a">
<style>
  .tab-content { display: none; }
  #rooms { display: block; }
  .card { border-radius: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  @media print {
    body > * { display: none !important; }
    #print-container { display: block !important; position: absolute; left: 0; top: 0; width: 100%; height: 100%; margin: 0; padding: 0; }
    .invoice-container { width: 300px; margin: 0 auto; padding: 10px; font-size: 12px; line-height: 1.4; border: none !important; }
  }
</style>
</head>
<body class="bg-gray-100 text-gray-800">

<header class="bg-green-600 text-white p-4 text-center text-xl font-bold shadow">
  üè† Qu·∫£n l√Ω Nh√† Tr·ªç PWA
</header>

<div class="min-h-screen flex flex-col">
  <!-- Nav tabs -->
  <nav class="flex bg-gray-800 text-white shadow-lg">
    <button class="tab flex-1 px-4 py-3 bg-green-700 hover:bg-green-700 transition" data-tab="rooms">Ph√≤ng</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="occupancy">Thu√™ / Tr·∫£</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="invoice">H√≥a ƒë∆°n</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="history">L·ªãch s·ª≠</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="settings">C√†i ƒë·∫∑t gi√°</button>
  </nav>

  <main class="p-4 flex-1 space-y-4">

    <!-- Ph√≤ng -->
    <section id="rooms" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">‚ûï Th√™m ph√≤ng</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input id="roomName" placeholder="T√™n ph√≤ng (VD: P101)" class="p-2 border rounded col-span-2" />
          <input id="roomPrice" type="number" placeholder="Gi√° thu√™ (VNƒê)" class="p-2 border rounded" min="0" />
        </div>
        <button id="addRoomBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">Th√™m ph√≤ng</button>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4" id="roomCards"></div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üìã Danh s√°ch ph√≤ng (b·∫£ng)</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left table-auto">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3">T√™n</th>
                <th class="p-3">Gi√°</th>
                <th class="p-3">Tr·∫°ng th√°i</th>
                <th class="p-3 text-center">H√†nh ƒë·ªông</th>
              </tr>
            </thead>
            <tbody id="roomTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- C√°c tab kh√°c gi·ªØ nguy√™n nh∆∞ code c≈© -->
    <section id="occupancy" class="tab-content space-y-4"></section>
    <section id="invoice" class="tab-content space-y-4"></section>
    <section id="history" class="tab-content space-y-4"></section>
    <section id="settings" class="tab-content space-y-4"></section>

  </main>
</div>

<div id="print-container" style="display: none;"></div>

<!-- JS c≈© gi·ªØ nguy√™n, ch·ªâ th√™m render card -->
<script>
const API_BASE_URL = 'https://nhatro-mi7x.onrender.com/api';

// ƒëƒÉng k√Ω service worker PWA
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').then(()=>console.log('SW registered')).catch(console.error);
}

let globalRoomData = [];

async function fetchAPI(endpoint, method='GET', body=null){
  const options = {method, headers:{'Content-Type':'application/json'}};
  if(body) options.body = JSON.stringify(body);
  return fetch(`${API_BASE_URL}/${endpoint}`, options)
    .then(async res=>{if(!res.ok){let err={};try{err=await res.json()}catch(e){err={error:`HTTP ${res.status}`}}throw new Error(err.error||`HTTP ${res.status}`)} return res.status===204?{}:res.json()})
    .catch(e=>{alert(`L·ªói k·∫øt n·ªëi: ${e.message}`); throw e});
}

const tabs = document.querySelectorAll('.tab');
tabs.forEach(tab=>{tab.addEventListener('click',()=>{
  document.querySelectorAll('.tab-content').forEach(c=>c.style.display='none');
  tabs.forEach(t=>t.classList.remove('bg-green-700'));
  const id=tab.dataset.tab;
  document.getElementById(id).style.display='block';
  tab.classList.add('bg-green-700');
})});

function escapeHtml(text){if(!text) return''; return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;')}
function fmtCurrency(n){return Number(n).toLocaleString('vi-VN')}

async function loadRooms(){
  const rooms = await fetchAPI('rooms');
  globalRoomData=rooms;

  // render b·∫£ng
  const tbody=document.getElementById('roomTable'); tbody.innerHTML='';
  let occupSel='<option value="">-- Ch·ªçn ph√≤ng tr·ªëng --</option>';
  rooms.forEach(r=>{
    tbody.innerHTML+=`<tr class="border-b hover:bg-gray-50 transition"><td class="p-3 font-medium">${escapeHtml(r.name)}</td><td class="p-3">${fmtCurrency(r.price)}</td><td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded ${r.status==='ƒêang thu√™'?'bg-red-100 text-red-800':'bg-green-100 text-green-800'}">${escapeHtml(r.status||'Tr·ªëng')}</span></td><td class="p-3 text-center"><button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition" onclick="deleteRoom('${r._id}')">X√≥a</button></td></tr>`;
    if(r.status==='Tr·ªëng') occupSel+=`<option value="${r._id}">${escapeHtml(r.name)}</option>`;
  });

  // render card ƒë·∫πp
  const cardContainer=document.getElementById('roomCards'); cardContainer.innerHTML='';
  rooms.forEach(r=>{
    cardContainer.innerHTML+=`<div class="card p-4 bg-white"><h3 class="font-semibold text-lg">${escapeHtml(r.name)}</h3><p>Gi√°: ${fmtCurrency(r.price)} VNƒê</p><p>Tr·∫°ng th√°i: <span class="font-bold ${r.status==='ƒêang thu√™'?'text-red-600':'text-green-600'}">${escapeHtml(r.status||'Tr·ªëng')}</span></p></div>`;
  });
}

document.addEventListener('DOMContentLoaded',()=>{loadRooms();});
</script>

</body>
</html>
