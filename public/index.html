<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Quáº£n lÃ½ NhÃ  Trá»</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  .tab-content { display: none; }
  #rooms { display: block; }

  @media print {
    body > * { display: none !important; }
    #print-container {
      display: block !important;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .invoice-container {
      width: 300px;
      margin: 0 auto;
      padding: 10px;
      font-size: 12px;
      line-height: 1.4;
      border: none !important;
    }
  }
</style>
</head>
<body class="bg-gray-100 text-gray-800">

<header class="bg-green-600 text-white p-4 text-center text-xl font-bold shadow">
  ğŸ  Quáº£n lÃ½ NhÃ  Trá»
</header>

<div class="min-h-screen flex flex-col">

  <!-- Nav tabs -->
  <nav class="flex bg-gray-800 text-white shadow-lg">
    <button class="tab flex-1 px-4 py-3 bg-green-700 hover:bg-green-700 transition" data-tab="rooms">PhÃ²ng</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="occupancy">ThuÃª / Tráº£</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="invoice">HÃ³a Ä‘Æ¡n</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="history">Lá»‹ch sá»­</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="settings">CÃ i Ä‘áº·t giÃ¡</button>
  </nav>

  <main class="p-4 flex-1 space-y-4">

    <!-- PhÃ²ng -->
    <section id="rooms" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">â• ThÃªm phÃ²ng</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input id="roomName" placeholder="TÃªn phÃ²ng (VD: P101)" class="p-2 border rounded col-span-2" />
          <input id="roomPrice" type="number" placeholder="GiÃ¡ thuÃª (VNÄ)" class="p-2 border rounded" min="0" />
        </div>
        <button id="addRoomBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">ThÃªm phÃ²ng</button>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">ğŸ“‹ Danh sÃ¡ch phÃ²ng</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left table-auto">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3">TÃªn</th>
                <th class="p-3">GiÃ¡</th>
                <th class="p-3">Tráº¡ng thÃ¡i</th>
                <th class="p-3 text-center">HÃ nh Ä‘á»™ng</th>
              </tr>
            </thead>
            <tbody id="roomTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- ThuÃª / Tráº£ -->
    <section id="occupancy" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">ğŸ”‘ ThuÃª phÃ²ng</h2>
        <div class="grid sm:grid-cols-3 gap-3">
          <select id="occupRoom" class="p-2 border rounded col-span-2">
            <option value="">-- Chá»n phÃ²ng trá»‘ng --</option>
          </select>
          <input id="tenantName" placeholder="TÃªn ngÆ°á»i thuÃª" class="p-2 border rounded" />
        </div>
        <button id="rentBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">ThuÃª phÃ²ng</button>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">ğŸšª Tráº£ phÃ²ng</h2>
        <div class="grid sm:grid-cols-2 gap-3">
          <select id="freeRoom" class="p-2 border rounded">
            <option value="">-- Chá»n (PhÃ²ng - NgÆ°á»i thuÃª) --</option>
          </select>
          <button id="freeBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">Tráº£ phÃ²ng</button>
        </div>
      </div>
    </section>

    <!-- HÃ³a Ä‘Æ¡n -->
    <section id="invoice" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">ğŸ§¾ Táº¡o hÃ³a Ä‘Æ¡n thÃ¡ng</h2>
        <div class="grid sm:grid-cols-2 gap-3 mb-4">
          <input type="month" id="invoiceMonth" class="p-2 border rounded w-full">
          <button id="createInvoicesBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Táº¡o hÃ³a Ä‘Æ¡n</button>
        </div>
        <h3 class="text-md font-medium mb-2">Nháº­p chá»‰ sá»‘/PhÃ­ phÃ¡t sinh</h3>
        <div id="invoiceList" class="space-y-3 max-h-96 overflow-y-auto p-2 border rounded bg-gray-50"></div>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">ğŸ“œ Danh sÃ¡ch hÃ³a Ä‘Æ¡n</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left table-auto">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3">MÃ£</th>
                <th class="p-3">PhÃ²ng</th>
                <th class="p-3 text-right">Tá»•ng (VNÄ)</th>
                <th class="p-3">Tráº¡ng thÃ¡i</th>
                <th class="p-3 text-center">Xem/In</th>
                <th class="p-3 text-center">HÃ nh Ä‘á»™ng</th>
              </tr>
            </thead>
            <tbody id="invoiceTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Lá»‹ch sá»­ -->
    <section id="history" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">â±ï¸ Lá»‹ch sá»­ hoáº¡t Ä‘á»™ng</h2>
        <div class="overflow-x-auto">
          <table class="w-full text-left table-auto">
            <thead class="bg-gray-100">
              <tr>
                <th class="p-3">Thá»i gian</th>
                <th class="p-3">HÃ nh Ä‘á»™ng</th>
                <th class="p-3">Chi tiáº¿t</th>
              </tr>
            </thead>
            <tbody id="historyTable"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CÃ i Ä‘áº·t giÃ¡ -->
    <section id="settings" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">âš™ï¸ CÃ i Ä‘áº·t giÃ¡ dá»‹ch vá»¥</h2>
        <div class="grid sm:grid-cols-2 gap-3 mb-4">
          <div>
            <label class="block mb-1 text-sm font-medium">GiÃ¡ Ä‘iá»‡n (Ä‘/kWh)</label>
            <input type="number" id="priceElec" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">GiÃ¡ nÆ°á»›c (Ä‘/mÂ³)</label>
            <input type="number" id="priceWater" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Tiá»n rÃ¡c (Ä‘/phÃ²ng/thÃ¡ng)</label>
            <input type="number" id="priceTrash" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Wifi (Ä‘/thÃ¡ng)</label>
            <input type="number" id="priceWifi" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">PhÃ­ khÃ¡c cá»‘ Ä‘á»‹nh (Ä‘/phÃ²ng/thÃ¡ng)</label>
            <input type="number" id="priceOther" class="p-2 border rounded w-full" min="0">
          </div>
        </div>
        <button id="saveSettingsBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">LÆ°u giÃ¡</button>
      </div>
    </section>

  </main>
</div>

<div id="print-container" style="display: none;"></div>

<!-- JS cÅ© giá»¯ nguyÃªn -->
<script>
const API_BASE_URL = 'https://nhatro-mi7x.onrender.com/api';


let globalRoomData = []; 
let globalSettings = {};

async function fetchAPI(endpoint, method = 'GET', body = null) {
Â  const options = {
Â  Â  method,
Â  Â  headers: { 'Content-Type': 'application/json' },
Â  };
Â  if (body) {
Â  Â  options.body = JSON.stringify(body);
Â  }
Â  return fetch(`${API_BASE_URL}/${endpoint}`, options).then(async res => {
Â  Â  if (!res.ok) {
Â  Â  Â  Â  let errorBody = {};
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  errorBody = await res.json();
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  errorBody = { error: `Lá»—i HTTP ${res.status}` };
Â  Â  Â  Â  }
Â  Â  Â  Â  throw new Error(errorBody.error || `HTTP error! status: ${res.status}`);
Â  Â  }
Â  Â  return res.status === 204 ? {} : res.json();
Â  }).catch(error => {
Â  Â  alert(`Lá»—i káº¿t ná»‘i hoáº·c xá»­ lÃ½: ${error.message}. Äáº£m báº£o server Ä‘ang cháº¡y.`);
Â  Â  throw error; 
Â  });
}

const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');

tabs.forEach(tab => {
Â  tab.addEventListener('click', () => {
Â  Â  tabContents.forEach(c => c.style.display = 'none');
Â  Â  tabs.forEach(t => t.classList.remove('bg-green-700'));

Â  Â  const targetId = tab.dataset.tab;
Â  Â  const targetContent = document.getElementById(targetId);
Â  Â  if (targetContent) {
Â  Â  Â  targetContent.style.display = 'block';
Â  Â  }

Â  Â  tab.classList.add('bg-green-700');
Â  });
});

function escapeHtml(text) { if (!text) return ''; return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
function fmtCurrency(n) { return Number(n).toLocaleString('vi-VN'); }

async function loadRooms() {
Â  try {
Â  Â  const rooms = await fetchAPI('rooms');
Â  Â  globalRoomData = rooms; 
Â  Â  
Â  Â  const tbody = document.getElementById('roomTable');
Â  Â  tbody.innerHTML = '';
Â  Â  
Â  Â  let occupSel = '<option value="">-- Chá»n phÃ²ng trá»‘ng --</option>';
Â  Â  rooms.forEach(r => {
Â  Â  Â  tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 transition">
Â  Â  Â  Â  <td class="p-3 font-medium">${escapeHtml(r.name)}</td>
Â  Â  Â  Â  <td class="p-3">${fmtCurrency(r.price)} VNÄ</td>
Â  Â  Â  Â  <td class="p-3"><span class="px-2 py-1 text-xs font-semibold rounded ${r.status === 'Äang thuÃª' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${escapeHtml(r.status || 'Trá»‘ng')}</span></td>
Â  Â  Â  Â  <td class="p-3 text-center">
Â  Â  Â  Â  Â  <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition" onclick="deleteRoom('${r._id}')">XÃ³a</button>
Â  Â  Â  Â  </td>
Â  Â  Â  </tr>`;
Â  Â  Â  if (r.status === 'Trá»‘ng') occupSel += `<option value="${r._id}">${escapeHtml(r.name)}</option>`;
Â  Â  });
Â  Â  document.getElementById('occupRoom').innerHTML = occupSel;
Â  Â  buildInvoiceList(rooms);
Â  } catch (e) {
Â  Â  console.error("Lá»—i loadRooms:", e);
Â  }
}

document.getElementById('addRoomBtn').addEventListener('click', async () => {
Â  const name = document.getElementById('roomName').value.trim();
Â  const price = +document.getElementById('roomPrice').value;
Â  if (!name || isNaN(price) || price <= 0) return alert('Nháº­p tÃªn vÃ  giÃ¡ thuÃª há»£p lá»‡.');
Â  
Â  await fetchAPI('rooms', 'POST', { name, price });
Â  
Â  document.getElementById('roomName').value = '';
Â  document.getElementById('roomPrice').value = '';
Â  await loadData();
});

async function deleteRoom(id) {
Â  if (!confirm('XÃ¡c nháº­n xÃ³a phÃ²ng? HÃ nh Ä‘á»™ng nÃ y sáº½ xÃ³a cÃ¡c thÃ´ng tin thuÃª liÃªn quan.')) return;
Â  await fetchAPI(`rooms/${id}`, 'DELETE');
Â  await loadData();
}

async function loadOccupancies() {
Â  try {
Â  Â  const data = await fetchAPI('occupancy');
Â  Â  
Â  Â  let freeHtml = '<option value="">-- Chá»n má»¥c Ä‘á»ƒ tráº£ phÃ²ng --</option>';
Â  Â  data.forEach(o => {
Â  Â  Â  if (o.active && o.room) {
Â  Â  Â  Â  const roomName = o.room.name || 'PhÃ²ng';
Â  Â  Â  Â  freeHtml += `<option value="${o._id}">${escapeHtml(roomName)} â€” ${escapeHtml(o.tenant || '')}</option>`;
Â  Â  Â  }
Â  Â  });
Â  Â  document.getElementById('freeRoom').innerHTML = freeHtml;
Â  } catch (e) {
Â  Â  console.error("Lá»—i loadOccupancies:", e);
Â  }
}

document.getElementById('rentBtn').addEventListener('click', async () => {
Â  const roomId = document.getElementById('occupRoom').value;
Â  const tenant = document.getElementById('tenantName').value.trim();
Â  if (!roomId || !tenant) return alert('Chá»n phÃ²ng vÃ  nháº­p tÃªn ngÆ°á»i thuÃª.');
Â  
Â  await fetchAPI('occupancy', 'POST', { roomId, tenant });
Â  
Â  document.getElementById('tenantName').value = '';
Â  await loadData();
});

document.getElementById('freeBtn').addEventListener('click', async () => {
Â  const occId = document.getElementById('freeRoom').value;
Â  if (!occId) return alert('Chá»n phÃ²ng cáº§n tráº£.');
Â  
Â  await fetchAPI(`occupancy/${occId}`, 'DELETE');
Â  
Â  await loadData();
});

async function loadHistory() {
Â  try {
Â  Â  const data = await fetchAPI('history');
Â  Â  
Â  Â  const tbody = document.getElementById('historyTable');
Â  Â  tbody.innerHTML = '';
Â  Â  
Â  Â  data.forEach(h => {
Â  Â  Â  tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 transition">
Â  Â  Â  Â  <td class="p-3 text-sm">${new Date(h.createdAt).toLocaleString()}</td>
Â  Â  Â  Â  <td class="p-3 font-medium">${escapeHtml(h.action)}</td>
Â  Â  Â  Â  <td class="p-3 text-sm">${escapeHtml(h.info)}</td>
Â  Â  Â  </tr>`;
Â  Â  });
Â  } catch (e) {
Â  Â  console.error("Lá»—i loadHistory:", e);
Â  }
}

async function loadSettings() {
Â  try {
Â  Â  const s = await fetchAPI('settings');
Â  Â  globalSettings = s;

Â  Â  document.getElementById('priceElec').value = s.priceElec || 3000;
Â  Â  document.getElementById('priceWater').value = s.priceWater || 10000;
Â  Â  document.getElementById('priceTrash').value = s.priceTrash || 20000;
Â  Â  document.getElementById('priceWifi').value = s.priceWifi || 50000;
Â  Â  document.getElementById('priceOther').value = s.priceOther || 0; 

Â  } catch (e) {
Â  Â  console.error("Lá»—i loadSettings:", e);
Â  }
}

document.getElementById('saveSettingsBtn').addEventListener('click', async () => {
Â  const s = {
Â  Â  priceElec: +document.getElementById('priceElec').value,
Â  Â  priceWater: +document.getElementById('priceWater').value,
Â  Â  priceTrash: +document.getElementById('priceTrash').value,
Â  Â  priceWifi: +document.getElementById('priceWifi').value,
Â  Â  priceOther: +document.getElementById('priceOther').value
Â  };

Â  if(Object.values(s).some(val => isNaN(val) || val < 0)) return alert('GiÃ¡ dá»‹ch vá»¥ pháº£i lÃ  sá»‘ khÃ´ng Ã¢m.');

Â  await fetchAPI('settings', 'POST', s);
Â  
Â  alert('ÄÃ£ lÆ°u giÃ¡ dá»‹ch vá»¥ thÃ nh cÃ´ng!');
Â  await loadSettings(); 
});

function buildInvoiceList(rooms) {
Â  const container = document.getElementById('invoiceList');
Â  container.innerHTML = '';
Â  const roomsInUse = rooms.filter(r => r.status === 'Äang thuÃª');
Â  
Â  if (roomsInUse.length === 0) {
Â  Â  container.innerHTML = '<p class="text-center text-gray-500 py-4">ChÆ°a cÃ³ phÃ²ng nÃ o Ä‘ang Ä‘Æ°á»£c thuÃª.</p>';
Â  Â  return;
Â  }
Â  
Â  roomsInUse.forEach(r => {
Â  Â  container.innerHTML += `
Â  Â  Â  <div class="p-3 border rounded grid sm:grid-cols-6 gap-2 items-center bg-white shadow-sm" data-room-id="${r._id}" data-room-name="${r.name}">
Â  Â  Â  Â  <div class="font-semibold text-green-700 col-span-full sm:col-span-1">${escapeHtml(r.name)}</div>
Â  Â  Â  Â  <div><input type="number" placeholder="Äiá»‡n BÄ" class="p-1 border rounded w-full elecBegin" min="0"></div>
Â  Â  Â  Â  <div><input type="number" placeholder="Äiá»‡n KT" class="p-1 border rounded w-full elecEnd" min="0"></div>
Â  Â  Â  Â  <div><input type="number" placeholder="NÆ°á»›c BÄ" class="p-1 border rounded w-full waterBegin" min="0"></div>
Â  Â  Â  Â  <div><input type="number" placeholder="NÆ°á»›c KT" class="p-1 border rounded w-full waterEnd" min="0"></div>
Â  Â  Â  Â  <div class="col-span-full sm:col-span-1"><input type="number" placeholder="PhÃ­ khÃ¡c (Náº¿u cÃ³)" class="p-1 border rounded w-full otherFee" value="0" min="0"></div>
Â  Â  Â  </div>`;
Â  });
}

async function createInvoices() {
Â  const monthYear = document.getElementById('invoiceMonth').value;
Â  if (!monthYear) return alert('Vui lÃ²ng chá»n thÃ¡ng Ä‘á»ƒ táº¡o hÃ³a Ä‘Æ¡n.');
Â  
Â  const [year, month] = monthYear.split('-').map(Number);
Â  
Â  const s = globalSettings;
Â  if (!s || Object.keys(s).length === 0) {
Â  Â  alert('ChÆ°a táº£i Ä‘Æ°á»£c cÃ i Ä‘áº·t giÃ¡ dá»‹ch vá»¥. Vui lÃ²ng kiá»ƒm tra tab CÃ i Ä‘áº·t.');
Â  Â  return;
Â  }
Â  
Â  const items = [];
Â  let validInvoiceCount = 0;
Â  
Â  document.querySelectorAll('#invoiceList > div').forEach(div => {
Â  Â  const roomId = div.dataset.roomId;
Â  Â  const roomName = div.dataset.roomName;
Â  Â  
Â  Â  const elecBegin = +div.querySelector('.elecBegin').value;
Â  Â  const elecEnd = +div.querySelector('.elecEnd').value;
Â  Â  const waterBegin = +div.querySelector('.waterBegin').value;
Â  Â  const waterEnd = +div.querySelector('.waterEnd').value;
Â  Â  const otherFee = +div.querySelector('.otherFee').value || 0;

Â  Â  if (isNaN(elecBegin) || isNaN(elecEnd) || isNaN(waterBegin) || isNaN(waterEnd) || 
Â  Â  Â  Â  elecEnd < elecBegin || waterEnd < waterBegin || elecBegin < 0 || waterBegin < 0) {
Â  Â  Â  console.warn(`Bá» qua hÃ³a Ä‘Æ¡n phÃ²ng ${roomName} do chá»‰ sá»‘ khÃ´ng há»£p lá»‡.`);
Â  Â  Â  return; 
Â  Â  }
Â  Â  
Â  Â  items.push({
Â  Â  Â  roomId, 
Â  Â  Â  roomName, 
Â  Â  Â  month, 
Â  Â  Â  year, 
Â  Â  Â  elecBegin, 
Â  Â  Â  elecEnd, 
Â  Â  Â  waterBegin, 
Â  Â  Â  waterEnd,
Â  Â  Â  otherFee
Â  Â  });
Â  Â  validInvoiceCount++;
Â  });

Â  if (validInvoiceCount === 0) return alert('KhÃ´ng cÃ³ hÃ³a Ä‘Æ¡n há»£p lá»‡ nÃ o Ä‘Æ°á»£c táº¡o.');

Â  await fetchAPI('invoices', 'POST', { invoices: items });
Â  
Â  alert(`ÄÃ£ táº¡o ${validInvoiceCount} hÃ³a Ä‘Æ¡n thÃ nh cÃ´ng cho thÃ¡ng ${month}/${year}!`);
Â  await loadData();
}

document.getElementById('createInvoicesBtn').addEventListener('click', createInvoices);

async function loadInvoices() {
Â  try {
Â  Â  const invs = await fetchAPI('invoices');
Â  Â  
Â  Â  const tbody = document.getElementById('invoiceTable');
Â  Â  tbody.innerHTML = '';
Â  Â  
Â  Â  invs.forEach(i => {
Â  Â  Â  const isPaid = i.paid;
Â  Â  Â  const roomName = i.roomName || (i.room?.name || 'PhÃ²ng'); 
Â  Â  Â  
Â  Â  Â  tbody.innerHTML += `<tr class="border-b hover:bg-gray-50 transition">
Â  Â  Â  Â  <td class="p-3 text-sm font-code">${i.code}</td>
Â  Â  Â  Â  <td class="p-3">${escapeHtml(roomName)}</td>
Â  Â  Â  Â  <td class="p-3 font-bold text-right text-red-600">${fmtCurrency(i.total)} VNÄ</td>
Â  Â  Â  Â  <td class="p-3">
Â  Â  Â  Â  Â  <span class="px-2 py-1 text-xs font-semibold rounded ${isPaid ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
Â  Â  Â  Â  Â  Â  ${isPaid ? 'ÄÃ£ thanh toÃ¡n' : 'ChÆ°a thanh toÃ¡n'}
Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  </td>
Â  Â  Â  Â  <td class="p-3 text-center">
Â  Â  Â  Â  Â  <button class="bg-indigo-500 text-white px-3 py-1 rounded text-sm hover:bg-indigo-600 transition" onclick="printInvoice('${i._id}')">In</button>
Â  Â  Â  Â  </td>
Â  Â  Â  Â  <td class="p-3 text-center">
Â  Â  Â  Â  Â  ${!isPaid ? `<button class="bg-blue-500 text-white px-3 py-1 rounded text-sm mb-1 hover:bg-blue-600 transition" onclick="payInvoice('${i._id}', true)">Thanh toÃ¡n</button>` : `<button class="bg-yellow-500 text-white px-3 py-1 rounded text-sm mb-1 hover:bg-yellow-600 transition" onclick="payInvoice('${i._id}', false)">Há»§y TT</button>`}
Â  Â  Â  Â  Â  <button class="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600 transition" onclick="deleteInvoice('${i._id}')">XÃ³a</button>
Â  Â  Â  Â  </td>
Â  Â  Â  </tr>`;
Â  Â  });
Â  } catch (e) {
Â  Â  console.error("Lá»—i loadInvoices:", e);
Â  }
}

async function payInvoice(id, paidStatus) {
Â  const confirmMsg = paidStatus ? 'XÃ¡c nháº­n hÃ³a Ä‘Æ¡n nÃ y Ä‘Ã£ Ä‘Æ°á»£c thanh toÃ¡n?' : 'XÃ¡c nháº­n Há»¦Y tráº¡ng thÃ¡i Ä‘Ã£ thanh toÃ¡n?';
Â  if (!confirm(confirmMsg)) return;
Â  
Â  await fetchAPI(`invoices/${id}`, 'PUT', { paid: paidStatus });
Â  
Â  await loadData();
}

async function deleteInvoice(id) {
Â  if (!confirm('XÃ¡c nháº­n xÃ³a hÃ³a Ä‘Æ¡n nÃ y?')) return;
Â  await fetchAPI(`invoices/${id}`, 'DELETE');
Â  
Â  await loadData();
}

async function getInvoiceAndSettings(id) {
Â  const invs = await fetchAPI('invoices');
Â  const invoice = invs.find(i => i._id === id);
Â  const settings = await fetchAPI('settings'); 
Â  return { invoice, settings };
}

function generateInvoiceHtml(invoice, settings) {
Â  const isPaid = invoice.paid ? 'ÄÃƒ THANH TOÃN' : 'CHÆ¯A THANH TOÃN';
Â  const monthYear = `${invoice.month}/${invoice.year}`;
Â  const total = fmtCurrency(invoice.total);
Â  const roomPrice = invoice.roomPrice || (invoice.room?.price || 0);
Â  
Â  const priceElec = invoice.elecTotal / (invoice.elecUsed || 1) || settings.priceElec || 3000;
Â  const priceWater = invoice.waterTotal / (invoice.waterUsed || 1) || settings.priceWater || 10000;

Â  return `
Â  Â  <html>
Â  Â  <head>
Â  Â  Â  <title>HÃ³a Ä‘Æ¡n ${invoice.code}</title>
Â  Â  Â  <style>
Â  Â  Â  Â  body { font-family: Tahoma, sans-serif; font-size: 11px; margin: 0; padding: 0; }
Â  Â  Â  Â  .invoice-container { width: 300px; margin: 0 auto; padding: 10px; border: 1px dashed #000; }
Â  Â  Â  Â  .header { text-align: center; margin-bottom: 10px; }
Â  Â  Â  Â  .header h1 { font-size: 14px; margin: 0; }
Â  Â  Â  Â  .info-line { display: flex; justify-content: space-between; margin-bottom: 3px; }
Â  Â  Â  Â  .info-line .label { font-weight: bold; }
Â  Â  Â  Â  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
Â  Â  Â  Â  th, td { padding: 4px 2px; text-align: left; border-bottom: 1px dotted #ddd; }
Â  Â  Â  Â  .text-right { text-align: right; }
Â  Â  Â  Â  .total-row { font-weight: bold; background-color: #eee; }
Â  Â  Â  Â  .status { text-align: center; font-size: 14px; font-weight: bold; margin-top: 10px; padding: 5px; border: 2px solid ${invoice.paid ? 'green' : 'red'}; }
Â  Â  Â  Â  .note { font-style: italic; font-size: 10px; margin-top: 10px; }
Â  Â  Â  Â  
Â  Â  Â  Â  @media print {
Â  Â  Â  Â  Â  Â  .invoice-container { border: none !important; }
Â  Â  Â  Â  }
Â  Â  Â  </style>
Â  Â  </head>
Â  Â  <body>
Â  Â  Â  <div class="invoice-container">
Â  Â  Â  Â  <div class="header">
Â  Â  Â  Â  Â  <h1>PHIáº¾U THANH TOÃN TIá»€N TRá»Œ</h1>
Â  Â  Â  Â  Â  <p style="margin: 3px 0;">---------------------</p>
Â  Â  Â  Â  Â  <p>Ká»³: ThÃ¡ng ${monthYear}</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <div style="margin-top: 5px;">
Â  Â  Â  Â  Â  <div class="info-line"><span class="label">PhÃ²ng:</span> <span>${invoice.roomName || ''}</span></div>
Â  Â  Â  Â  Â  <div class="info-line"><span class="label">MÃ£ HÄ:</span> <span>${invoice.code}</span></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  
Â  Â  Â  Â  <hr style="margin: 8px 0; border-top: 1px dotted #000;"/>
Â  Â  Â  Â  
Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  <tr><th>Dá»‹ch vá»¥</th><th class="text-right">SL/ÄÆ¡n giÃ¡</th><th class="text-right">ThÃ nh tiá»n (VNÄ)</th></tr>
Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  <tr><td>1. Tiá»n phÃ²ng</td><td class="text-right">PhÃ­ cá»‘ Ä‘á»‹nh</td><td class="text-right">${fmtCurrency(roomPrice)}</td></tr>
Â  Â  Â  Â  Â  Â  <tr><td>2. Tiá»n Ä‘iá»‡n</td><td class="text-right">${invoice.elecUsed} kWh x ${fmtCurrency(priceElec)}</td><td class="text-right">${fmtCurrency(invoice.elecTotal)}</td></tr>
Â  Â  Â  Â  Â  Â  <tr><td>3. Tiá»n nÆ°á»›c</td><td class="text-right">${invoice.waterUsed} mÂ³ x ${fmtCurrency(priceWater)}</td><td class="text-right">${fmtCurrency(invoice.waterTotal)}</td></tr>
Â  Â  Â  Â  Â  Â  <tr><td>4. PhÃ­ Wifi</td><td class="text-right">PhÃ­ cá»‘ Ä‘á»‹nh</td><td class="text-right">${fmtCurrency(invoice.wifi)}</td></tr>
Â  Â  Â  Â  Â  Â  <tr><td>5. PhÃ­ RÃ¡c</td><td class="text-right">PhÃ­ cá»‘ Ä‘á»‹nh</td><td class="text-right">${fmtCurrency(invoice.trash)}</td></tr>
Â  Â  Â  Â  Â  Â  ${invoice.otherFee > 0 ? `<tr><td>6. PhÃ­ khÃ¡c</td><td class="text-right">PhÃ¡t sinh</td><td class="text-right">${fmtCurrency(invoice.otherFee)}</td></tr>` : ''}
Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  </table>

Â  Â  Â  Â  <hr style="margin: 8px 0; border-top: 1px solid #000;"/>

Â  Â  Â  Â  <div class="info-line total-row" style="font-size: 12px; padding: 3px 0;">
Â  Â  Â  Â  Â  <span>Tá»”NG Cá»˜NG:</span>
Â  Â  Â  Â  Â  <span class="text-right" style="font-size: 14px; color: #d9534f;">${total} VNÄ</span>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="status" style="color: ${invoice.paid ? 'green' : 'red'};">${isPaid}</div>
Â  Â  Â  Â  
Â  Â  Â  Â  <p class="note">Xin quÃ½ khÃ¡ch kiá»ƒm tra ká»¹ hÃ³a Ä‘Æ¡n trÆ°á»›c khi thanh toÃ¡n. Cáº£m Æ¡n!</p>
Â  Â  Â  Â  
Â  Â  Â  Â  <div style="margin-top: 15px; display: flex; justify-content: space-around; text-align: center;">
Â  Â  Â  Â  Â  Â  <div>NgÆ°á»i láº­p phiáº¿u</div>
Â  Â  Â  Â  Â  Â  <div>NgÆ°á»i thuÃª</div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </body>
Â  Â  </html>
Â  `;
}

async function printInvoice(id) {
Â  try {
Â  Â  const { invoice, settings } = await getInvoiceAndSettings(id);

Â  Â  if (!invoice) return alert('KhÃ´ng tÃ¬m tháº¥y hÃ³a Ä‘Æ¡n.');

Â  Â  const printHtml = generateInvoiceHtml(invoice, settings);

Â  Â  const printWindow = window.open('', '_blank', 'width=350,height=600');
Â  Â  printWindow.document.write(printHtml);
Â  Â  printWindow.document.close();
Â  Â  
Â  Â  printWindow.onload = function() {
Â  Â  Â  printWindow.print();
Â  Â  };
Â  } catch (e) {
Â  Â  console.error("Lá»—i printInvoice:", e);
Â  }
}


async function loadData() {
Â  await loadSettings(); 
Â  await loadRooms(); 
Â  await loadOccupancies();
Â  await loadInvoices();
Â  await loadHistory();
}

document.addEventListener('DOMContentLoaded', () => {
Â  const today = new Date();
Â  const month = (today.getMonth() + 1).toString().padStart(2, '0');
Â  const year = today.getFullYear();
Â  document.getElementById('invoiceMonth').value = `${year}-${month}`;
Â  
Â  loadData();
});
</script>

</body>
</html>
