<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Qu·∫£n l√Ω Nh√† Tr·ªç</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#16a34a" />
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/feather-icons"></script>
<style>
  .tab-content { display: none; }
  #rooms { display: block; }

  @media print {
    body > * { display: none !important; }
    #print-container {
      display: block !important;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .invoice-container {
      width: 300px;
      margin: 0 auto;
      padding: 10px;
      font-size: 12px;
      line-height: 1.4;
      border: none !important;
    }
  }
</style>
</head>
<body class="bg-gray-100 text-gray-800">

<header class="bg-green-600 text-white p-4 text-center text-xl font-bold shadow flex justify-center items-center gap-2">
  <i data-feather="home" class="w-6 h-6"></i> Qu·∫£n l√Ω Nh√† Tr·ªç
</header>

<div class="min-h-screen flex flex-col">

  <!-- Nav tabs -->
  <nav class="flex bg-gray-800 text-white shadow-lg">
    <button class="tab flex-1 px-4 py-3 bg-green-700 hover:bg-green-700 transition" data-tab="rooms">Ph√≤ng</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="occupancy">Thu√™ / Tr·∫£</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="invoice">H√≥a ƒë∆°n</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="history">L·ªãch s·ª≠</button>
    <button class="tab flex-1 px-4 py-3 hover:bg-gray-700 transition" data-tab="settings">C√†i ƒë·∫∑t gi√°</button>
  </nav>

  <main class="p-4 flex-1 space-y-4">

    <!-- Ph√≤ng -->
    <section id="rooms" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">‚ûï Th√™m ph√≤ng</h2>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <input id="roomName" placeholder="T√™n ph√≤ng (VD: P101)" class="p-2 border rounded col-span-2" />
          <input id="roomPrice" type="number" placeholder="Gi√° thu√™ (VNƒê)" class="p-2 border rounded" min="0" />
        </div>
        <button id="addRoomBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">Th√™m ph√≤ng</button>
      </div>

      <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4" id="roomCards"></div>
    </section>

    <!-- Thu√™ / Tr·∫£ -->
    <section id="occupancy" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üîë Thu√™ ph√≤ng</h2>
        <div class="grid sm:grid-cols-3 gap-3">
          <select id="occupRoom" class="p-2 border rounded col-span-2">
            <option value="">-- Ch·ªçn ph√≤ng tr·ªëng --</option>
          </select>
          <input id="tenantName" placeholder="T√™n ng∆∞·ªùi thu√™" class="p-2 border rounded" />
        </div>
        <button id="rentBtn" class="mt-4 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">Thu√™ ph√≤ng</button>
      </div>

      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üö™ Tr·∫£ ph√≤ng</h2>
        <div class="grid sm:grid-cols-2 gap-3">
          <select id="freeRoom" class="p-2 border rounded">
            <option value="">-- Ch·ªçn (Ph√≤ng - Ng∆∞·ªùi thu√™) --</option>
          </select>
          <button id="freeBtn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">Tr·∫£ ph√≤ng</button>
        </div>
      </div>
    </section>

    <!-- H√≥a ƒë∆°n -->
    <section id="invoice" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">üßæ T·∫°o h√≥a ƒë∆°n th√°ng</h2>
        <div class="grid sm:grid-cols-2 gap-3 mb-4">
          <input type="month" id="invoiceMonth" class="p-2 border rounded w-full">
          <button id="createInvoicesBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">T·∫°o h√≥a ƒë∆°n</button>
        </div>
        <h3 class="text-md font-medium mb-2">Nh·∫≠p ch·ªâ s·ªë/Ph√≠ ph√°t sinh</h3>
        <div id="invoiceList" class="space-y-3 max-h-96 overflow-y-auto p-2 border rounded bg-gray-50"></div>
      </div>

      <div id="invoiceCards" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
    </section>

    <!-- L·ªãch s·ª≠ -->
    <section id="history" class="tab-content space-y-4">
      <div id="historyCards" class="grid sm:grid-cols-1 lg:grid-cols-2 gap-4"></div>
    </section>

    <!-- C√†i ƒë·∫∑t gi√° -->
    <section id="settings" class="tab-content space-y-4">
      <div class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3 border-b pb-2">‚öôÔ∏è C√†i ƒë·∫∑t gi√° d·ªãch v·ª•</h2>
        <div class="grid sm:grid-cols-2 gap-3 mb-4">
          <div>
            <label class="block mb-1 text-sm font-medium">Gi√° ƒëi·ªán (ƒë/kWh)</label>
            <input type="number" id="priceElec" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Gi√° n∆∞·ªõc (ƒë/m¬≥)</label>
            <input type="number" id="priceWater" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Ti·ªÅn r√°c (ƒë/ph√≤ng/th√°ng)</label>
            <input type="number" id="priceTrash" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Wifi (ƒë/th√°ng)</label>
            <input type="number" id="priceWifi" class="p-2 border rounded w-full" min="0">
          </div>
          <div>
            <label class="block mb-1 text-sm font-medium">Ph√≠ kh√°c c·ªë ƒë·ªãnh (ƒë/ph√≤ng/th√°ng)</label>
            <input type="number" id="priceOther" class="p-2 border rounded w-full" min="0">
          </div>
        </div>
        <button id="saveSettingsBtn" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">L∆∞u gi√°</button>
      </div>
    </section>

  </main>
</div>

<div id="print-container" style="display: none;"></div>

<script>
feather.replace();

const API_BASE_URL = 'https://nhatro-mi7x.onrender.com/api';
let globalRoomData = []; 
let globalSettings = {};

async function fetchAPI(endpoint, method = 'GET', body = null) {
  const options = { method, headers: { 'Content-Type': 'application/json' } };
  if (body) options.body = JSON.stringify(body);
  return fetch(`${API_BASE_URL}/${endpoint}`, options)
    .then(async res => {
      if (!res.ok) { 
        let errorBody = {}; 
        try { errorBody = await res.json(); } catch(e) { errorBody = { error: `L·ªói HTTP ${res.status}` }; }
        throw new Error(errorBody.error || `HTTP error! status: ${res.status}`);
      }
      return res.status === 204 ? {} : res.json();
    }).catch(error => { alert(`L·ªói k·∫øt n·ªëi ho·∫∑c x·ª≠ l√Ω: ${error.message}`); throw error; });
}

const tabs = document.querySelectorAll('.tab');
const tabContents = document.querySelectorAll('.tab-content');
tabs.forEach(tab => tab.addEventListener('click', () => {
  tabContents.forEach(c => c.style.display = 'none');
  tabs.forEach(t => t.classList.remove('bg-green-700'));
  const targetContent = document.getElementById(tab.dataset.tab);
  if(targetContent) targetContent.style.display = 'block';
  tab.classList.add('bg-green-700');
}));

function escapeHtml(text) { if (!text) return ''; return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;'); }
function fmtCurrency(n) { return Number(n).toLocaleString('vi-VN'); }

// ------------------- Load Rooms & Render Card -------------------
async function loadRooms() {
  try {
    const rooms = await fetchAPI('rooms');
    globalRoomData = rooms;
    const roomCards = document.getElementById('roomCards');
    roomCards.innerHTML = '';
    let occupSel = '<option value="">-- Ch·ªçn ph√≤ng tr·ªëng --</option>';
    rooms.forEach(r => {
      const card = document.createElement('div');
      card.className = 'bg-white rounded-xl shadow p-4 hover:shadow-lg transition';
      card.innerHTML = `
        <h3 class="font-semibold text-lg">${escapeHtml(r.name)}</h3>
        <p>Gi√° thu√™: <span class="font-bold text-green-700">${fmtCurrency(r.price)} VNƒê</span></p>
        <p>Tr·∫°ng th√°i: <span class="px-2 py-1 rounded text-sm ${r.status==='ƒêang thu√™'?'bg-red-100 text-red-800':'bg-green-100 text-green-800'}">${escapeHtml(r.status||'Tr·ªëng')}</span></p>
        <button class="mt-2 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 transition" onclick="deleteRoom('${r._id}')">X√≥a</button>
      `;
      roomCards.appendChild(card);
      if(r.status==='Tr·ªëng') occupSel += `<option value="${r._id}">${escapeHtml(r.name)}</option>`;
    });
    document.getElementById('occupRoom').innerHTML = occupSel;
    buildInvoiceList(rooms);
  } catch(e){ console.error(e); }
}

// --- C√°c ph·∫ßn x·ª≠ l√Ω thu√™/tr·∫£, t·∫°o h√≥a ƒë∆°n, load settings, history, invoices gi·ªØ nguy√™n ---
async function loadData() {
  await loadSettings(); 
  await loadRooms(); 
  await loadOccupancies();
  await loadInvoices();
  await loadHistory();
}

document.addEventListener('DOMContentLoaded', () => {
  const today = new Date();
  const month = (today.getMonth() + 1).toString().padStart(2,'0');
  const year = today.getFullYear();
  document.getElementById('invoiceMonth').value = `${year}-${month}`;
  loadData();
});

// --- PWA Service Worker ƒëƒÉng k√Ω ---
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').then(reg => console.log('SW ƒëƒÉng k√Ω:', reg.scope)).catch(err=>console.log(err));
}
</script>

</body>
</html>
